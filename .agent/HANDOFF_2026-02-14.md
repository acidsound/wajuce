# Handoff Notes (2026-02-14)

## Scope Of This Handoff
This document captures the concrete implementation/debugging context that led to
`wajuce` release `0.1.4` and should be used as a starting point for follow-up
audio bug fixing, spec-alignment work, and release maintenance.

## Release Facts
- Version: `0.1.4`
- Release commit: `6a63e60`
- Tag: `v0.1.4`
- Branch at release: `main`
- Publish outcome: uploaded successfully to pub.dev

## Validation At Release
- Static checks:
  - `dart analyze` -> no issues
- Pub quality:
  - `pana --no-warning --source path .` -> `160/160`
  - `dart pub publish --dry-run` -> `0 warnings`

## Major Technical Changes (Recent)

### 1) Worklet module lifecycle alignment
- Introduced explicit module registry flow (`WAWorkletModules`) and integrated
  it with `WAWorklet.addModule(...)`.
- Added resolve behavior for URL-like module identifiers.
- Goal: keep API behavior close to Web Audio `audioWorklet.addModule()`.

Key files:
- `lib/src/worklet/wa_worklet.dart`
- `lib/src/worklet/wa_worklet_module.dart`
- `lib/src/context.dart`
- `lib/src/backend/backend_web.dart`

### 2) Sequencer/example refactor toward WebAudio-like usage
- `example/lib/clock_processor.dart` now encapsulates processor/module details.
- `example/lib/main.dart` uses helper functions to load module and create node.
- Sequencer parameter update path was centralized to reduce ad-hoc updates and
  make behavior more predictable.

Key files:
- `example/lib/clock_processor.dart`
- `example/lib/main.dart`

### 3) Native machine-voice stereo routing fix
- `createMachineVoice()` internal connections were corrected to route both
  channel 0 and channel 1 through the chain.
- This addressed practical left-channel-only behavior reports.

Key file:
- `native/engine/Source/WajuceEngine.mm`

### 4) Native feedback loop restoration for machine voice
- External feedback pattern `Delay -> Gain -> Delay` was restored using managed
  feedback bridge nodes (`FeedbackSender/FeedbackReceiver`), preserving the
  one-block delayed cycle-safe model.
- This fixed reports where feedback sounded like one-shot only.

Key files:
- `native/engine/Source/WajuceEngine.mm`
- `native/engine/Source/Processors.h`

### 5) Delay behavior handling in example
- Delay-time control path was adjusted so `delayTime` remains synchronized as an
  AudioParam, independent of wet bypass control.
- Wet/feedback gains are treated as bypass/mix controls.

Key file:
- `example/lib/main.dart`

### 6) Mic monitoring behavior
- Added mono-input upmix behavior in `MediaStreamSourceProcessor` to reduce
  left-biased monitoring behavior in iOS-like mono input scenarios.

Key file:
- `native/engine/Source/Processors.h`

### 7) Automation and API wiring cleanup
- `cancelAndHoldAtTime` path wiring and related param automation internals were
  refined and exposed consistently across backends.

Key files:
- `lib/src/audio_param.dart`
- `lib/src/backend/backend_juce.dart`
- `lib/src/backend/backend_web.dart`
- `native/engine/Source/ParamAutomation.h`
- `native/engine/Source/WajuceEngine.mm`

## Spec Intent Notes (Important)
- Delay behavior should follow WebAudio semantics:
  - `DelayNode.delayTime` is a regular AudioParam, not gated by enabled state.
  - Effect bypass should be modeled by graph/mix gains, not by freezing
    `delayTime`.
- Gain behavior should follow WebAudio semantics:
  - `GainNode` scales incoming signal continuously; if feedback loop is present,
    repeats must continue while gain > 0 and loop path exists.

Reference:
- <https://www.w3.org/TR/webaudio-1.1/#DelayNode>
- <https://www.w3.org/TR/webaudio-1.1/#GainNode>

## Known Follow-up Areas
- Continue reducing click/tick artifacts when rapidly changing synth params
  (tune/cutoff/play-stop transitions) while preserving spec-correct automation.
- Re-check sequencer behavior parity on Web backend against native.
- Consider explicit integration tests for:
  - feedback continuity
  - stereo routing invariants
  - delay-time modulation behavior at enable boundary

## Practical Commands

```bash
# Analyze
dart analyze

# Package quality
~/.pub-cache/bin/pana --no-warning --source path .
dart pub publish --dry-run

# iOS simulator run (example)
cd example
flutter run -d <simulator-udid>
```

## Notes On Local Workspace
- `AGENTS.md` may be kept untracked locally by workflow preference.
- Before next release, ensure a clean git state to avoid dry-run warnings.
